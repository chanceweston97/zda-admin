set -e

APP_PATH="${{ secrets.APP_PATH }}"
cd "$APP_PATH"

echo "==> Loading Node environment"
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

node -v
npm -v

echo "==> Ensure Yarn exists"
yarn -v || npm install -g yarn@1.22.22

echo "==> Clean old builds"
rm -rf node_modules
rm -rf .medusa

echo "==> Install dependencies"
yarn install

echo "==> Set production environment variables"
export NODE_ENV=production
export MEDUSA_BACKEND_URL="https://admin.zdacomm.com"
export MEDUSA_ADMIN_BACKEND_URL="https://admin.zdacomm.com"
export ADMIN_CORS="https://admin.zdacomm.com"
export STORE_CORS="https://store.zdacomm.com"
export BACKEND_URL="https://admin.zdacomm.com"

echo "==> Build Medusa"
NODE_OPTIONS="--max-old-space-size=4096" npx medusa build

echo "==> Verify admin build"
if [ ! -f ".medusa/server/public/admin/index.html" ]; then
  echo "âŒ Admin build missing"
  exit 1
fi
echo "âœ“ Admin build exists"

echo "==> Run database migrations"
npx medusa db:migrate || true

echo "==> Restart Medusa with PM2"
pm2 stop medusa-backend || true
pm2 delete medusa-backend || true

pm2 start "npx medusa start" \
  --name medusa-backend \
  --cwd .medusa/server \
  --env production

pm2 save

echo "ğŸš€ Deployment completed successfully"
