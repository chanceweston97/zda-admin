          
name: Deploy Backend to EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Upload project to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        source: "."
        target: ${{ secrets.APP_PATH }}

    - name: Build and run on EC2
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          set -e
          
          cd ${{ secrets.APP_PATH }}
          
          # Setup Node.js environment
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
          
          # Setup Yarn
          corepack enable
          corepack prepare yarn@4.6.0 --activate
          
          # Install dependencies
          echo "Installing dependencies..."
          yarn install --immutable
          
          # Set environment variables
          BACKEND_URL="http://${{ secrets.EC2_HOST }}:9000"
          export MEDUSA_BACKEND_URL="$BACKEND_URL"
          export NODE_ENV=production
          echo "MEDUSA_BACKEND_URL=$BACKEND_URL" >> .env
          
          # Ensure static directory exists
          mkdir -p static
          
          # Clean previous builds
          echo "Cleaning previous builds..."
          rm -rf .medusa
          rm -rf node_modules/.vite
          rm -rf node_modules/.cache
          
          # Build Medusa (backend + admin) - MUST happen on server
          echo "Building Medusa (this may take 3-5 minutes)..."
          NODE_OPTIONS="--max-old-space-size=4096" yarn build
          
          # Medusa v2 builds admin to .medusa/client/ but medusa start expects .medusa/admin/
          # Copy client build to admin location
          if [ -f ".medusa/client/index.html" ]; then
            echo "✓ Admin build found at .medusa/client/index.html"
            echo "Copying to .medusa/admin/ for medusa start..."
            mkdir -p .medusa/admin
            cp -r .medusa/client/* .medusa/admin/
          else
            echo "ERROR: Admin build not found at .medusa/client/index.html"
            echo "Build output:"
            find .medusa -type f -name "*.html" 2>/dev/null || echo "No HTML files found"
            exit 1
          fi
          
          # Verify admin build exists (required for yarn start)
          if [ ! -f ".medusa/admin/index.html" ]; then
            echo "ERROR: Admin build verification failed - .medusa/admin/index.html not found"
            exit 1
          fi
          
          echo "✓ Build successful! Admin ready at .medusa/admin/index.html"
          
          # Restart PM2 with production start command
          echo "Restarting PM2..."
          pm2 stop admin || true
          pm2 delete admin || true
          pm2 start yarn --name admin -- dev
          pm2 save
          
          echo "✓ Deployment complete!"
